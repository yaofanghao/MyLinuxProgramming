<!--
 * @Author: yao fanghao
 * @Date: 2023-04-14 22:13:52
 * @LastEditTime: 2023-06-01 20:28:30
 * @LastEditors: yao fanghao
-->

# 参考资料

* **CSAPP**
* **操作系统导论OSTEP**
* **APUE**
* https://stevens.netmeister.org/631/
* 软件调试
* 王道-操作系统
* 操作系统真象还原
* 小林coding-图解系统
* 嵌入式软件开发笔试面试指南
* Linux是怎样工作的 √
* [[过期] 2020 南京大学 “操作系统：设计与实现” (蒋炎岩)] <https://www.bilibili.com/video/BV1N741177F5/>
* 【彻底搞懂 进程&线程、进程池&线程池】 <https://www.bilibili.com/video/BV1V84y1Y77s/>

# 操作系统概念

* 特点
  * 并发
  * 共享
  * 虚拟
  * 异步

* Linux
  * 多任务、SMP对称多处理、ELF可执行文件、宏内核
* Windows
  * NT、PE可执行文件、混合型内核

# 进程与线程

## -进程

* 进程的状态
  * 运行台 就绪态 阻塞态（等待态） 创建态 终止态
  * ![1](_img/OS/process.png "进程状态")  
  
* 进程控制块 PCB
  * **PCB 是进程存在的唯一标志**

* 并发：交替进行
* 并行：同时进行 --流水线

## -线程

* 线程间可以并发运行且共享相同的地址空间
* 进程中一个线程崩溃，其他线程都崩溃
* **线程是调度的基本单位，进程是资源拥有的基本单位**

* 线程的实现
  * 用户线程的整个线程管理和调度，操作系统不直接参与
  * 用户级线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度等
  * 内核线程由操作系统管理程对应的TCB放在操作系统
  * 内核线程的创建、终止和管理都由操作系统负责
  * 轻量级线程 LWP

## -进程调度算法

* **需要考虑的因素**
  * CPU利用率
  * 吞吐量。长作业会降低吞吐量
  * 周转时间。进程运行和阻塞时间的总和
  * 等待时间。进程处于就绪队列的时间
  * 响应时间。交互式系统中衡量调度算法的主要标准

* FCFS 先来先服务调度算法
  * 不可剥夺
  * 效率低，适用于CPU繁忙型作业
  * 对长作业有利，对短作业不利
  
* SJF 短作业优先调度算法
  * 对短作业有利
  * 相比FCFS降低了平均周转时间
  * 可能会导致长作业“饥饿”现象
  
* 优先级调度算法
  * 分为非抢占式和抢占式
  * 优先级设置规则：
    * 系统进程>用户进程 交互型>非交互型 I/O型>计算型
  
* RR 时间片轮转调度算法
  * 适用于分时系统，提高交互体验
  * 选择适当的时间片很重要
  
* MLFQ **多级反馈队列调度算法**
  * ![1](_img/OS/MFQ.png "MFQ") 
  * 动态调整优先级和时间片大小
  * **多个就绪队列，每个队列不同优先级**
  * **每个队列进程运行时间片不同**
  * **每个队列采用FCFS算法**
  * **按队列优先级调度**
  * 优点：短作业优先，周转时间短，长作业不会饿死

## -死锁

* 死锁产生需同时满足的四个条件
  * 互斥
  * 不剥夺
  * 请求并保持
  * 循环等待

## -进程通信

* 共享存储
  * P、V 操作
* 消息队列
* 信号量
* 管道通信
  * 一次性操作，只支持半双工
  * 生产者消费者模式
* 套接字
* FIFO

## -协程

* 是一种比线程更加轻量级的存在。正如一个进程可以拥有多个线程一样，一个线程也可以拥有多个协程。 最重要的是，协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行）。 这样带来的好处就是性能得到了很大的提升，不会像线程切换那样消耗资源。

# 内存管理

## -虚拟内存

* 不同进程的虚拟地址和不同内存的物理地址映射
* 虚拟地址（VA）---> **内存管理单元（MMU）** ---> [映射到]物理地址（PA）

* 管理方式：内存分段和**内存分页**
* 内存分段：
  * 段表：段号、段基地址、段界限
  * 问题：内存碎片、交换效率低s
* 内存分页
  * 把整个虚拟和物理内存空间分为若干页
  * 每一页4kb
  * 换出换入 swap out / swap in
  * ![1](_img/OS/page.png "页")
  * **页表**：页号、页内偏移
  * 多级页表
    * 解决页表过大的问题
  * **TLB**-Translation Lookaside Buffer
    * 页表缓存，局部性原理
* **段页式内存管理**
  * 段号、段内页号和页内位移
  * 第一次访问段表，得到页表起始地址；
  * 第二次访问页表，得到物理页号；
  * 第三次将物理页号与页内位移组合，得到物理地址。
  * ![1](_img/OS/seg-page.png "段页")

## Linux内存管理

* ![1](_img/OS/linux-mem.png " " )

* 程序文件段 .text
  * 包括二进制可执行代码
* 已初始化数据段 .data
  * 包括静态常量
* 未初始化数据段 .dbss
  * 包括未初始化的静态变量
* 堆段
  * 包括动态分配的内存，从低地址开始向上增长
* 文件映射段
  * 包括动态库、共享内存等，从低地址开始向上增长（跟硬件和内核版本有关）
* 栈段
  * 包括局部变量和函数调用的上下文等
* 堆和文件映射段的内存动态分配
  * 比如使用C标准库的 malloc() 或 mmap() ，就可以分别在堆和文件映射段动态分配内存。

## -页面置换算法

* OPT 最佳置换算法
  * 无法实现，但作为评价基准
  
* FIFO 先进先出页面置换算法
  * Belady异常

* **LRU 最近最久未使用置换算法**
  * 最新访问放在第一位
  * 缓存满了删除末尾（最不经常访问的数据）
